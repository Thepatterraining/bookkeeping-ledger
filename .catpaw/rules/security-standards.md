---
ruleType: Model Request
description: 安全编码规范，包含编码安全、网络访问安全、接口安全等规约
globs:
---
rule编写规则: https://km.sankuai.com/collabpage/2710344014

# 安全编码规约

## 编码安全

### SQL注入防护
- 【强制】执行SQL语句时，对于表名、列名等无法通过预编译进行参数绑定的场景，必须白名单验证或采用安全SDK进行校验
- 【强制】执行SQL查询时，对入参必须采用预编译方式进行变量绑定，严禁将查询参数直接拼接至SQL语句中

### 命令注入防护
- 【强制】防止命令注入攻击，慎用系统命令完成操作，避免使用shell上下文执行命令
- 推荐使用Java原生代码代替命令操作
- 不可避免使用Runtime或ProcessBuilder时，使不可信数据仅作为命令参数传入并经过严格校验

### 序列化安全
- 【强制】不要反序列化不受信任的数据
- 【强制】禁止直接使用ObjectInputStream进行反序列化，必须继承ObjectInputStream类，重写resolveClass方法
- 【强制】禁止在Fastjson和Jackson库中开启动态类型功能，避免远程恶意代码执行

### 其他编码安全
- 【强制】禁止使用标准上下文执行SpEL表达式，应该使用SimpleEvaluationContext
- 【强制】XML解析器必须关闭外部实体(DTD)解析，避免XML外部实体(XXE)注入攻击
- 【强制】防止XPath注入，XPath查询时要对不可信输入做验证和清理
- 【建议】避免使用不安全的加密算法、Hash算法，推荐使用AES、SHA-256等安全算法
- 【强制】对称加密算法中禁止使用固定的初始化向量
- 【建议】敏感场景推荐使用java.security.SecureRandom，避免使用不安全的随机数生成器
- 【强制】所有用户输入数据在输出到HTML文档前必须进行转义处理，避免XSS安全漏洞

## 网络访问安全

### 请求地址安全
- 【强制】发起网络请求并且请求地址由外部提供时，应当对请求目的地址进行安全检查
- 【建议】使用白名单方式限制请求的域名范围，防止服务器端请求伪造(SSRF)攻击
- 【建议】避免使用HTTP、FTP、WebSocket等未加密的协议进行通信，推荐使用HTTPS、SFTP、WSS

### 认证凭据安全
- 【强制】禁止源码中硬编码认证凭据类信息，如私钥、token、认证密码、API密钥等
- 推荐做法：
  - 将认证凭据作为环境变量
  - 使用KMS来管理认证凭据
  - 使用公司统一的认证系统

### 其他网络安全
- 【建议】避免在代码中使用固定IP地址标识服务地址，减少安全风险
- 【建议】优先选择公共服务，避免自建或本地存储数据

## HTTP协议安全

### 响应头安全
- 【建议】正确设置HTTP中安全有关的响应头：
  - X-Content-Type-Options：设置为"nosniff"
  - X-Frame-Options：防止点击劫持
  - Content-Security-Policy：防止跨站脚本攻击
  - Strict-Transport-Security：强制HTTPS通信

### 跨域和重定向安全
- 【强制】禁止未限制的跨域请求，避免非法获取敏感资源
- 【强制】验证30x跳转(服务端重定向)的目的地址是否可信，避免被钓鱼

### Cookie安全
- 【建议】设置安全相关的Cookie属性：
  - HttpOnly标志：防止通过JavaScript访问Cookie
  - Secure标志：Cookie只通过HTTPS协议发送
  - SameSite：防止跨站请求伪造(CSRF)攻击
- 【建议】最小化设置Cookie作用域，减少Cookie被未授权页面访问的风险
- 【建议】避免过长的Cookie过期时间，建议不超过15天
- 【强制】禁止在Cookie中存储敏感信息如用户密码、加解密密钥等

## 接口安全

### 认证和权限控制
- 【强制】服务接口必须要有认证和权限控制，确保只有获得授权的用户才能访问
- 【强制】禁止通过GET参数传递长期认证类的Token，推荐在请求头或Cookie中进行传输
- 【强制】依据隐私保护管理规范，个人敏感信息需要脱敏

### 异常和错误处理
- 【强制】禁止向浏览器端返回任何可能对攻击者有利的信息
- 程序异常时，建议将用户重定向到默认错误提示页，并仅返回必要信息

### 防护机制
- 【强制】对外透出数据的接口需要防止恶意爬虫
- 【强制】使用平台资源(短信/邮件/电话/下单/支付等)必须实现防刷
- 【强制】涉及内容生产和对外透出的场景需要接入违禁词过滤

### 文件上传安全
- 【强制】文件上传功能，仅允许业务所需文件类型上传，避免上传可执行文件
- 【强制】防止路径穿越风险，文件操作时需判断文件名和文件路径参数
- 建议重命名用户上传的文件，推荐使用随机字符串或UUID进行命名

### 其他接口安全
- 【建议】限制返回结果数量的最大值，建议不超过100条，避免性能问题
